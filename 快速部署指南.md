# 快速部署指南

## 一键启动

### 前置要求

- Docker 20.10+
- Docker Compose 2.0+
- 至少 4GB 可用内存

### 启动步骤

1. **下载项目**

```bash
cd end_system
```

2. **配置邮件（可选）**

如果需要邮件通知功能，创建 `.env` 文件：

```bash
cat > .env << 'EOF'
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_DEFAULT_SENDER=your-email@gmail.com
EOF
```

3. **启动服务**

```bash
# 方式一：使用启动脚本
chmod +x start.sh
./start.sh

# 方式二：直接使用 docker-compose
docker-compose up -d
```

4. **等待服务启动**

首次启动需要下载镜像和初始化数据库，大约需要 2-3 分钟。

5. **访问系统**

- **前端界面**：http://localhost:5173
- **后端API**：http://localhost:5000
- **API文档**：http://localhost:5000/apidocs
- **模拟平台**：http://localhost:5001/api/v1/stats

### 验证部署

```bash
# 检查所有服务状态
docker-compose ps

# 预期输出：所有服务状态为 "Up"
# NAME                           STATUS
# job_monitor_backend            Up
# job_monitor_celery_beat        Up
# job_monitor_celery_worker      Up
# job_monitor_frontend           Up
# job_monitor_mock_platform      Up
# job_monitor_postgres           Up (healthy)
# job_monitor_redis              Up (healthy)
```

### 测试系统

1. 访问 http://localhost:5173
2. 点击"立即注册"
3. 填写用户名、邮箱、密码
4. 登录系统
5. 创建一个监控规则（关键词：Python）
6. 点击"测试"按钮
7. 查看"扫描结果"页面

## 常用命令

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务
docker-compose logs -f backend
docker-compose logs -f celery_worker
docker-compose logs -f celery_beat
```

### 重启服务

```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart backend
```

### 停止服务

```bash
# 停止但保留数据
docker-compose stop

# 停止并删除容器（保留数据卷）
docker-compose down

# 完全清除（包括数据）
docker-compose down -v
```

### 更新代码

```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker-compose up -d --build
```

## 生产环境部署

### 1. 安全配置

修改 `docker-compose.yml`，更新密钥：

```yaml
environment:
  SECRET_KEY: 使用强随机字符串
  JWT_SECRET_KEY: 使用强随机字符串
  POSTGRES_PASSWORD: 使用强密码
```

生成随机密钥：

```bash
python -c "import secrets; print(secrets.token_hex(32))"
```

### 2. 使用外部数据库

如果使用云数据库，修改环境变量：

```yaml
environment:
  DATABASE_URL: postgresql://user:pass@your-db-host:5432/dbname
```

### 3. 配置域名和HTTPS

使用 Nginx 反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:5173;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /api {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

然后配置 Let's Encrypt SSL：

```bash
sudo certbot --nginx -d your-domain.com
```

### 4. 监控和日志

使用系统级日志：

```bash
# 配置日志输出到文件
docker-compose logs -f > /var/log/job_monitor.log 2>&1 &
```

### 5. 备份数据库

```bash
# 创建备份
docker-compose exec postgres pg_dump -U admin job_monitor > backup.sql

# 恢复备份
docker-compose exec -T postgres psql -U admin job_monitor < backup.sql
```

## 性能优化

### 1. 调整Worker数量

修改 `docker-compose.yml`：

```yaml
celery_worker:
  command: celery -A app.celery_app worker -l info --concurrency=4
```

### 2. 增加数据库连接池

修改 `backend/config.py`：

```python
SQLALCHEMY_POOL_SIZE = 10
SQLALCHEMY_MAX_OVERFLOW = 20
```

### 3. 配置Redis持久化

修改 `docker-compose.yml`：

```yaml
redis:
  command: redis-server --appendonly yes
```

## 故障排除

### 端口冲突

如果端口被占用，修改 `docker-compose.yml` 中的端口映射：

```yaml
ports:
  - "8173:5173"  # 前端
  - "8000:5000"  # 后端
```

### 内存不足

减少服务资源占用：

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 512M
```

### 数据库初始化失败

手动执行迁移：

```bash
docker-compose exec backend flask db upgrade
```

## 监控告警

### 健康检查

```bash
# 检查后端健康
curl http://localhost:5000/health

# 检查模拟平台
curl http://localhost:5001/health

# 检查Redis
docker-compose exec redis redis-cli ping
```

### 定时检查脚本

创建 `health_check.sh`：

```bash
#!/bin/bash
if ! curl -f http://localhost:5000/health > /dev/null 2>&1; then
    echo "Backend is down!" | mail -s "Alert" admin@example.com
    docker-compose restart backend
fi
```

配置 crontab：

```bash
*/5 * * * * /path/to/health_check.sh
```

---

部署完成后，建议查看完整的《使用指南.md》了解系统功能。

